import { AudioContext } from './audio-context';
let drawVisual;
const defaultOptions = {
    width: 300,
    height: 150,
    strokeColor: '#212121',
    backgroundColor: 'white',
};
export const AudioVisualizer = {
    visualizeSineWave({ canvas, backgroundColor, strokeColor, width, height, }) {
        const canvasCtx = canvas.getContext('2d');
        let analyser = AudioContext.getAnalyser();
        const bufferLength = analyser.fftSize;
        const dataArray = new Uint8Array(bufferLength);
        canvasCtx.clearRect(0, 0, width, height);
        function draw() {
            drawVisual = requestAnimationFrame(draw);
            analyser = AudioContext.getAnalyser();
            analyser.getByteTimeDomainData(dataArray);
            canvasCtx.fillStyle = backgroundColor;
            canvasCtx.fillRect(0, 0, width, height);
            canvasCtx.lineWidth = 2;
            canvasCtx.strokeStyle = strokeColor;
            canvasCtx.beginPath();
            const sliceWidth = width / bufferLength;
            let x = 0;
            for (let i = 0; i < bufferLength; i++) {
                const v = dataArray[i] / 128.0;
                const y = (v * height) / 2;
                if (i === 0) {
                    canvasCtx.moveTo(x, y);
                }
                else {
                    canvasCtx.lineTo(x, y);
                }
                x += sliceWidth;
            }
            canvasCtx.lineTo(canvas.width, canvas.height / 2);
            canvasCtx.stroke();
        }
        draw();
    },
    visualizeFrequencyBars({ canvas, backgroundColor, strokeColor, width, height, }) {
        const canvasCtx = canvas.getContext('2d');
        let analyser = AudioContext.getAnalyser();
        analyser.fftSize = 256;
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        canvasCtx.clearRect(0, 0, width, height);
        const draw = () => {
            drawVisual = requestAnimationFrame(draw);
            analyser = AudioContext.getAnalyser();
            analyser.getByteFrequencyData(dataArray);
            canvasCtx.fillStyle = backgroundColor;
            canvasCtx.fillRect(0, 0, width, height);
            const barWidth = (width / bufferLength) * 2.5;
            let barHeight;
            let x = 0;
            for (let i = 0; i < bufferLength; i++) {
                barHeight = dataArray[i];
                const rgb = this.hexToRgb(strokeColor);
                canvasCtx.fillStyle = strokeColor;
                canvasCtx.fillRect(x, height - barHeight / 2, barWidth, barHeight / 2);
                x += barWidth + 1;
            }
        };
        draw();
    },
    visualizeFrequencyCircles({ canvas, backgroundColor, strokeColor, width, height, }) {
        const canvasCtx = canvas.getContext('2d');
        let analyser = AudioContext.getAnalyser();
        analyser.fftSize = 32;
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        canvasCtx.clearRect(0, 0, width, height);
        const draw = () => {
            drawVisual = requestAnimationFrame(draw);
            analyser = AudioContext.getAnalyser();
            analyser.getByteFrequencyData(dataArray);
            const reductionAmount = 3;
            const reducedDataArray = new Uint8Array(bufferLength / reductionAmount);
            for (let i = 0; i < bufferLength; i += reductionAmount) {
                let sum = 0;
                for (let j = 0; j < reductionAmount; j++) {
                    sum += dataArray[i + j];
                }
                reducedDataArray[i / reductionAmount] = sum / reductionAmount;
            }
            canvasCtx.clearRect(0, 0, width, height);
            canvasCtx.beginPath();
            canvasCtx.arc(width / 2, height / 2, Math.min(height, width) / 2, 0, 2 * Math.PI);
            canvasCtx.fillStyle = backgroundColor;
            canvasCtx.fill();
            const stepSize = Math.min(height, width) / 2.0 / reducedDataArray.length;
            canvasCtx.strokeStyle = strokeColor;
            for (let i = 0; i < reducedDataArray.length; i++) {
                canvasCtx.beginPath();
                const normalized = reducedDataArray[i] / 128;
                const r = stepSize * i + stepSize * normalized;
                canvasCtx.arc(width / 2, height / 2, r, 0, 2 * Math.PI);
                canvasCtx.stroke();
            }
        };
        draw();
    },
    hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result
            ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16),
            }
            : null;
    },
    visualize(type, options) {
        this[`visualize${type || 'SineWave'}`]({
            ...defaultOptions,
            ...options
        });
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXVkaW8tdmlzdWFsaXplci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1taWMtcmVjb3JkZXIvc3JjL2xpYi91dGlscy9hdWRpby12aXN1YWxpemVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUUvQyxJQUFJLFVBQVUsQ0FBQztBQVVmLE1BQU0sY0FBYyxHQUE4QztJQUNoRSxLQUFLLEVBQUUsR0FBRztJQUNWLE1BQU0sRUFBRSxHQUFHO0lBQ1gsV0FBVyxFQUFFLFNBQVM7SUFDdEIsZUFBZSxFQUFFLE9BQU87Q0FDekIsQ0FBQTtBQU1ELE1BQU0sQ0FBQyxNQUFNLGVBQWUsR0FBRztJQUM3QixpQkFBaUIsQ0FBQyxFQUNoQixNQUFNLEVBQ04sZUFBZSxFQUNmLFdBQVcsRUFDWCxLQUFLLEVBQ0wsTUFBTSxHQUNvQjtRQUMxQixNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBNkIsQ0FBQztRQUN0RSxJQUFJLFFBQVEsR0FBRyxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUM7UUFFMUMsTUFBTSxZQUFZLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQztRQUN0QyxNQUFNLFNBQVMsR0FBRyxJQUFJLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUUvQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRXpDLFNBQVMsSUFBSTtZQUNYLFVBQVUsR0FBRyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUV6QyxRQUFRLEdBQUcsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBRXRDLFFBQVEsQ0FBQyxxQkFBcUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUUxQyxTQUFTLENBQUMsU0FBUyxHQUFHLGVBQWUsQ0FBQztZQUN0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QUMsRUFBRSxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDeEQsU0FBUyxDQUFDLE1BQU0sRUFBRSxDQUFDO2FBQ3BCO1FBQ0gsQ0FBQyxDQUFDO1FBQ0YsSUFBSSxFQUFFLENBQUM7SUFDVCxDQUFDO0lBRUQsUUFBUSxDQUFDLEdBQVc7UUFDbEIsTUFBTSxNQUFNLEdBQUcsMkNBQTJDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3JFLE9BQU8sTUFBTTtZQUNYLENBQUMsQ0FBQztnQkFDRSxDQUFDLEVBQUUsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUM7Z0JBQzFCLENBQUMsRUFBRSxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQztnQkFDMUIsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDO2FBQzNCO1lBQ0gsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUNYLENBQUM7SUFFRCxTQUFTLENBQUMsSUFBd0MsRUFBRSxPQUFhO1FBQy9ELElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxVQUFVLEVBQUUsQ0FBQyxDQUFDO1lBQ3JDLEdBQUcsY0FBYztZQUNqQixHQUFHLE9BQU87U0FDa0IsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7Q0FDRixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXVkaW9Db250ZXh0IH0gZnJvbSAnLi9hdWRpby1jb250ZXh0JztcclxuXHJcbmxldCBkcmF3VmlzdWFsO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBBdWRpb1Zpc3VhbGl6YXRpb25PcHRpb25zIHtcclxuICBjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50O1xyXG4gIHdpZHRoOiBudW1iZXI7XHJcbiAgaGVpZ2h0OiBudW1iZXI7XHJcbiAgYmFja2dyb3VuZENvbG9yOiBzdHJpbmc7XHJcbiAgc3Ryb2tlQ29sb3I6IHN0cmluZztcclxufVxyXG5cclxuY29uc3QgZGVmYXVsdE9wdGlvbnM6IE9taXQ8QXVkaW9WaXN1YWxpemF0aW9uT3B0aW9ucywgJ2NhbnZhcyc+ID0ge1xyXG4gIHdpZHRoOiAzMDAsXHJcbiAgaGVpZ2h0OiAxNTAsXHJcbiAgc3Ryb2tlQ29sb3I6ICcjMjEyMTIxJyxcclxuICBiYWNrZ3JvdW5kQ29sb3I6ICd3aGl0ZScsXHJcbn1cclxuXHJcbmV4cG9ydCB0eXBlIEF1ZGlvVmlzdWFsaXphdGlvblR5cGUgPSAnU2luZVdhdmUnIHwgJ0ZyZXF1ZW5jeUJhcnMnIHwgJ0ZyZXF1ZW5jeUNpcmNsZXMnO1xyXG5cclxudHlwZSBBcmdzID0gUGFydGlhbDxPbWl0PEF1ZGlvVmlzdWFsaXphdGlvbk9wdGlvbnMsICdjYW52YXMnPj4gJiBQaWNrPEF1ZGlvVmlzdWFsaXphdGlvbk9wdGlvbnMsICdjYW52YXMnPjtcclxuXHJcbmV4cG9ydCBjb25zdCBBdWRpb1Zpc3VhbGl6ZXIgPSB7XHJcbiAgdmlzdWFsaXplU2luZVdhdmUoe1xyXG4gICAgY2FudmFzLFxyXG4gICAgYmFja2dyb3VuZENvbG9yLFxyXG4gICAgc3Ryb2tlQ29sb3IsXHJcbiAgICB3aWR0aCxcclxuICAgIGhlaWdodCxcclxuICB9OiBBdWRpb1Zpc3VhbGl6YXRpb25PcHRpb25zKTogdm9pZCB7XHJcbiAgICBjb25zdCBjYW52YXNDdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKSBhcyBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQ7XHJcbiAgICBsZXQgYW5hbHlzZXIgPSBBdWRpb0NvbnRleHQuZ2V0QW5hbHlzZXIoKTtcclxuXHJcbiAgICBjb25zdCBidWZmZXJMZW5ndGggPSBhbmFseXNlci5mZnRTaXplO1xyXG4gICAgY29uc3QgZGF0YUFycmF5ID0gbmV3IFVpbnQ4QXJyYXkoYnVmZmVyTGVuZ3RoKTtcclxuXHJcbiAgICBjYW52YXNDdHguY2xlYXJSZWN0KDAsIDAsIHdpZHRoLCBoZWlnaHQpO1xyXG5cclxuICAgIGZ1bmN0aW9uIGRyYXcoKTogdm9pZCB7XHJcbiAgICAgIGRyYXdWaXN1YWwgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZHJhdyk7XHJcblxyXG4gICAgICBhbmFseXNlciA9IEF1ZGlvQ29udGV4dC5nZXRBbmFseXNlcigpO1xyXG5cclxuICAgICAgYW5hbHlzZXIuZ2V0Qnl0ZVRpbWVEb21haW5EYXRhKGRhdGFBcnJheSk7XHJcblxyXG4gICAgICBjYW52YXNDdHguZmlsbFN0eWxlID0gYmFja2dyb3VuZENvbG9yO1xyXG4gICAgICBjYW52YXNDdHguZmlsbFJlY3QoMCwgMCwgd2lkdGgsIGhlaWdodCk7XHJcblxyXG4gICAgICBjYW52YXNDdHgubGluZVdpZHRoID0gMjtcclxuICAgICAgY2FudmFzQ3R4LnN0cm9rZVN0eWxlID0gc3Ryb2tlQ29sb3I7XHJcblxyXG4gICAgICBjYW52YXNDdHguYmVnaW5QYXRoKCk7XHJcblxyXG4gICAgICBjb25zdCBzbGljZVdpZHRoID0gd2lkdGggLyBidWZmZXJMZW5ndGg7XHJcbiAgICAgIGxldCB4ID0gMDtcclxuXHJcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYnVmZmVyTGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBjb25zdCB2ID0gZGF0YUFycmF5W2ldIC8gMTI4LjA7XHJcbiAgICAgICAgY29uc3QgeSA9ICh2ICogaGVpZ2h0KSAvIDI7XHJcblxyXG4gICAgICAgIGlmIChpID09PSAwKSB7XHJcbiAgICAgICAgICBjYW52YXNDdHgubW92ZVRvKHgsIHkpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBjYW52YXNDdHgubGluZVRvKHgsIHkpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgeCArPSBzbGljZVdpZHRoO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjYW52YXNDdHgubGluZVRvKGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCAvIDIpO1xyXG4gICAgICBjYW52YXNDdHguc3Ryb2tlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgZHJhdygpO1xyXG4gIH0sXHJcblxyXG4gIHZpc3VhbGl6ZUZyZXF1ZW5jeUJhcnMoe1xyXG4gICAgY2FudmFzLFxyXG4gICAgYmFja2dyb3VuZENvbG9yLFxyXG4gICAgc3Ryb2tlQ29sb3IsXHJcbiAgICB3aWR0aCxcclxuICAgIGhlaWdodCxcclxuICB9OiBBdWRpb1Zpc3VhbGl6YXRpb25PcHRpb25zKTogdm9pZCB7XHJcbiAgICBjb25zdCBjYW52YXNDdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKSBhcyBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQ7XHJcbiAgICBsZXQgYW5hbHlzZXIgPSBBdWRpb0NvbnRleHQuZ2V0QW5hbHlzZXIoKTtcclxuICAgIGFuYWx5c2VyLmZmdFNpemUgPSAyNTY7XHJcbiAgICBjb25zdCBidWZmZXJMZW5ndGggPSBhbmFseXNlci5mcmVxdWVuY3lCaW5Db3VudDtcclxuICAgIGNvbnN0IGRhdGFBcnJheSA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlckxlbmd0aCk7XHJcblxyXG4gICAgY2FudmFzQ3R4LmNsZWFyUmVjdCgwLCAwLCB3aWR0aCwgaGVpZ2h0KTtcclxuXHJcbiAgICBjb25zdCBkcmF3ID0gKCkgPT4ge1xyXG4gICAgICBkcmF3VmlzdWFsID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGRyYXcpO1xyXG5cclxuICAgICAgYW5hbHlzZXIgPSBBdWRpb0NvbnRleHQuZ2V0QW5hbHlzZXIoKTtcclxuICAgICAgYW5hbHlzZXIuZ2V0Qnl0ZUZyZXF1ZW5jeURhdGEoZGF0YUFycmF5KTtcclxuXHJcbiAgICAgIGNhbnZhc0N0eC5maWxsU3R5bGUgPSBiYWNrZ3JvdW5kQ29sb3I7XHJcbiAgICAgIGNhbnZhc0N0eC5maWxsUmVjdCgwLCAwLCB3aWR0aCwgaGVpZ2h0KTtcclxuXHJcbiAgICAgIGNvbnN0IGJhcldpZHRoID0gKHdpZHRoIC8gYnVmZmVyTGVuZ3RoKSAqIDIuNTtcclxuICAgICAgbGV0IGJhckhlaWdodDtcclxuICAgICAgbGV0IHggPSAwO1xyXG5cclxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBidWZmZXJMZW5ndGg7IGkrKykge1xyXG4gICAgICAgIGJhckhlaWdodCA9IGRhdGFBcnJheVtpXTtcclxuXHJcbiAgICAgICAgY29uc3QgcmdiID0gdGhpcy5oZXhUb1JnYihzdHJva2VDb2xvcik7XHJcblxyXG4gICAgICAgIGNhbnZhc0N0eC5maWxsU3R5bGUgPSBzdHJva2VDb2xvcjtcclxuICAgICAgICBjYW52YXNDdHguZmlsbFJlY3QoeCwgaGVpZ2h0IC0gYmFySGVpZ2h0IC8gMiwgYmFyV2lkdGgsIGJhckhlaWdodCAvIDIpO1xyXG5cclxuICAgICAgICB4ICs9IGJhcldpZHRoICsgMTtcclxuICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBkcmF3KCk7XHJcbiAgfSxcclxuXHJcbiAgdmlzdWFsaXplRnJlcXVlbmN5Q2lyY2xlcyh7XHJcbiAgICBjYW52YXMsXHJcbiAgICBiYWNrZ3JvdW5kQ29sb3IsXHJcbiAgICBzdHJva2VDb2xvcixcclxuICAgIHdpZHRoLFxyXG4gICAgaGVpZ2h0LFxyXG4gIH06IEF1ZGlvVmlzdWFsaXphdGlvbk9wdGlvbnMpOiB2b2lkIHtcclxuICAgIGNvbnN0IGNhbnZhc0N0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpIGFzIENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRDtcclxuICAgIGxldCBhbmFseXNlciA9IEF1ZGlvQ29udGV4dC5nZXRBbmFseXNlcigpO1xyXG4gICAgYW5hbHlzZXIuZmZ0U2l6ZSA9IDMyO1xyXG4gICAgY29uc3QgYnVmZmVyTGVuZ3RoID0gYW5hbHlzZXIuZnJlcXVlbmN5QmluQ291bnQ7XHJcblxyXG4gICAgY29uc3QgZGF0YUFycmF5ID0gbmV3IFVpbnQ4QXJyYXkoYnVmZmVyTGVuZ3RoKTtcclxuICAgIGNhbnZhc0N0eC5jbGVhclJlY3QoMCwgMCwgd2lkdGgsIGhlaWdodCk7XHJcblxyXG4gICAgY29uc3QgZHJhdyA9ICgpID0+IHtcclxuICAgICAgZHJhd1Zpc3VhbCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZShkcmF3KTtcclxuICAgICAgYW5hbHlzZXIgPSBBdWRpb0NvbnRleHQuZ2V0QW5hbHlzZXIoKTtcclxuICAgICAgYW5hbHlzZXIuZ2V0Qnl0ZUZyZXF1ZW5jeURhdGEoZGF0YUFycmF5KTtcclxuICAgICAgY29uc3QgcmVkdWN0aW9uQW1vdW50ID0gMztcclxuICAgICAgY29uc3QgcmVkdWNlZERhdGFBcnJheSA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlckxlbmd0aCAvIHJlZHVjdGlvbkFtb3VudCk7XHJcblxyXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJ1ZmZlckxlbmd0aDsgaSArPSByZWR1Y3Rpb25BbW91bnQpIHtcclxuICAgICAgICBsZXQgc3VtID0gMDtcclxuICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHJlZHVjdGlvbkFtb3VudDsgaisrKSB7XHJcbiAgICAgICAgICBzdW0gKz0gZGF0YUFycmF5W2kgKyBqXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmVkdWNlZERhdGFBcnJheVtpIC8gcmVkdWN0aW9uQW1vdW50XSA9IHN1bSAvIHJlZHVjdGlvbkFtb3VudDtcclxuICAgICAgfVxyXG5cclxuICAgICAgY2FudmFzQ3R4LmNsZWFyUmVjdCgwLCAwLCB3aWR0aCwgaGVpZ2h0KTtcclxuICAgICAgY2FudmFzQ3R4LmJlZ2luUGF0aCgpO1xyXG4gICAgICBjYW52YXNDdHguYXJjKFxyXG4gICAgICAgIHdpZHRoIC8gMixcclxuICAgICAgICBoZWlnaHQgLyAyLFxyXG4gICAgICAgIE1hdGgubWluKGhlaWdodCwgd2lkdGgpIC8gMixcclxuICAgICAgICAwLFxyXG4gICAgICAgIDIgKiBNYXRoLlBJXHJcbiAgICAgICk7XHJcbiAgICAgIGNhbnZhc0N0eC5maWxsU3R5bGUgPSBiYWNrZ3JvdW5kQ29sb3I7XHJcbiAgICAgIGNhbnZhc0N0eC5maWxsKCk7XHJcbiAgICAgIGNvbnN0IHN0ZXBTaXplID0gTWF0aC5taW4oaGVpZ2h0LCB3aWR0aCkgLyAyLjAgLyByZWR1Y2VkRGF0YUFycmF5Lmxlbmd0aDtcclxuICAgICAgY2FudmFzQ3R4LnN0cm9rZVN0eWxlID0gc3Ryb2tlQ29sb3I7XHJcblxyXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlZHVjZWREYXRhQXJyYXkubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBjYW52YXNDdHguYmVnaW5QYXRoKCk7XHJcbiAgICAgICAgY29uc3Qgbm9ybWFsaXplZCA9IHJlZHVjZWREYXRhQXJyYXlbaV0gLyAxMjg7XHJcbiAgICAgICAgY29uc3QgciA9IHN0ZXBTaXplICogaSArIHN0ZXBTaXplICogbm9ybWFsaXplZDtcclxuICAgICAgICBjYW52YXNDdHguYXJjKHdpZHRoIC8gMiwgaGVpZ2h0IC8gMiwgciwgMCwgMiAqIE1hdGguUEkpO1xyXG4gICAgICAgIGNhbnZhc0N0eC5zdHJva2UoKTtcclxuICAgICAgfVxyXG4gICAgfTtcclxuICAgIGRyYXcoKTtcclxuICB9LFxyXG5cclxuICBoZXhUb1JnYihoZXg6IHN0cmluZyk6IHtyOiBudW1iZXIsIGc6IG51bWJlciwgYjogbnVtYmVyfSB8IG51bGwge1xyXG4gICAgY29uc3QgcmVzdWx0ID0gL14jPyhbYS1mXFxkXXsyfSkoW2EtZlxcZF17Mn0pKFthLWZcXGRdezJ9KSQvaS5leGVjKGhleCk7XHJcbiAgICByZXR1cm4gcmVzdWx0XHJcbiAgICAgID8ge1xyXG4gICAgICAgICAgcjogcGFyc2VJbnQocmVzdWx0WzFdLCAxNiksXHJcbiAgICAgICAgICBnOiBwYXJzZUludChyZXN1bHRbMl0sIDE2KSxcclxuICAgICAgICAgIGI6IHBhcnNlSW50KHJlc3VsdFszXSwgMTYpLFxyXG4gICAgICAgIH1cclxuICAgICAgOiBudWxsO1xyXG4gIH0sXHJcblxyXG4gIHZpc3VhbGl6ZSh0eXBlOiBBdWRpb1Zpc3VhbGl6YXRpb25UeXBlIHwgdW5kZWZpbmVkLCBvcHRpb25zOiBBcmdzKTogdm9pZCB7XHJcbiAgICB0aGlzW2B2aXN1YWxpemUke3R5cGUgfHwgJ1NpbmVXYXZlJ31gXSh7XHJcbiAgICAgIC4uLmRlZmF1bHRPcHRpb25zLFxyXG4gICAgICAuLi5vcHRpb25zXHJcbiAgICB9IGFzIEF1ZGlvVmlzdWFsaXphdGlvbk9wdGlvbnMpO1xyXG4gIH1cclxufTtcclxuIl19