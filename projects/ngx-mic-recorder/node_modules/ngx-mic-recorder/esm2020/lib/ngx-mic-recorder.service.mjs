import { Injectable } from '@angular/core';
import { BehaviorSubject, from, map, switchMap } from 'rxjs';
import { MP3Encoder } from './utils/mp3-encoder';
import { AudioContext } from './utils/audio-context';
import * as i0 from "@angular/core";
export class NgxMicRecorderService {
    constructor() {
        this._isRecordingSubject = new BehaviorSubject(false);
        this._isPausedSubject = new BehaviorSubject(false);
        this._recordingTimeSubject = new BehaviorSubject(0);
        this._recordedBlobSubject = new BehaviorSubject(null);
        this._recordingStateSubject = new BehaviorSubject('inactive');
        this._audioContext = new (window.AudioContext || window['webkitAudioContext'])();
        this._mp3Encoder = new MP3Encoder();
        this.isRecording$ = this._isRecordingSubject.asObservable();
        this.isPaused$ = this._isPausedSubject.asObservable();
        this.recordingTime$ = this._recordingTimeSubject.asObservable().pipe(map(s => new Date(s * 1000).toISOString().slice(11, 19)));
        this.recordedBlob$ = this._recordedBlobSubject.asObservable();
        this.recordedBlobAsMp3$ = this.recordedBlob$.pipe(switchMap(() => from(this._getMp3())));
        this.recordingState$ = this._recordingStateSubject.asObservable();
        this.toggleStartStop = () => {
            const isRecording = this._isRecordingSubject.getValue();
            if (isRecording) {
                this.stopRecording();
            }
            else {
                this.startRecording();
            }
        };
        this.startRecording = () => {
            if (this._timeInterval !== undefined)
                return;
            navigator.mediaDevices
                .getUserMedia({ audio: true })
                .then((stream) => {
                this._activeStream = stream;
                this._isRecordingSubject.next(true);
                const recorder = new MediaRecorder(stream);
                this._mediaRecorder = recorder;
                recorder.start();
                this._startTimer();
                this._recordingStateSubject.next('recording');
                this._mic = this._audioContext.createMediaStreamSource(stream);
                this._processor = this._audioContext.createScriptProcessor(0, 1, 1);
                this._mic.connect(this._processor);
                this._processor.connect(this._audioContext.destination);
                this._processor.onaudioprocess = (event) => {
                    this._mp3Encoder.encode(event.inputBuffer.getChannelData(0));
                };
                if (this._recordingEvents?.afterStartRecording)
                    this._recordingEvents?.afterStartRecording();
                recorder.addEventListener('dataavailable', (event) => {
                    this._recordedBlobSubject.next(event.data);
                    // if (onDataAvailable) onDataAvailable(event.data);
                    recorder.stream.getTracks().forEach((t) => t.stop());
                    this._mediaRecorder = undefined;
                });
                AudioContext.startAnalyze(stream);
            })
                .catch((err) => console.log(err));
        };
        this.stopRecording = () => {
            this._mediaRecorder?.stop();
            this._stopTimer();
            this._recordingTimeSubject.next(0);
            this._isRecordingSubject.next(false);
            this._isPausedSubject.next(false);
            this._recordingStateSubject.next('inactive');
            AudioContext.resetAnalyser();
            if (this._recordingEvents?.afterStopRecording)
                this._recordingEvents.afterStopRecording(this._recordedBlobSubject.getValue());
            if (this._processor && this._mic) {
                this._mic.disconnect();
                this._processor.disconnect();
                if (this._audioContext && this._audioContext.state !== 'closed') {
                    this._audioContext.close();
                }
                this._processor.onaudioprocess = null;
                this._activeStream?.getAudioTracks().forEach((track) => track.stop());
            }
        };
        this.togglePauseAndResume = () => {
            const isRecording = this._isRecordingSubject.getValue();
            if (!isRecording)
                return;
            const isPaused = this._isPausedSubject.getValue();
            if (isPaused) {
                this.resume();
            }
            else {
                this.pause();
            }
        };
        this.resume = () => {
            this._isPausedSubject.next(false);
            this._mediaRecorder?.resume();
            this._recordingStateSubject.next('recording');
            AudioContext.resumeAnalyze();
            void this._audioContext.resume();
            this._startTimer();
            if (this._recordingEvents?.onResume)
                this._recordingEvents.onResume();
        };
        this.pause = () => {
            this._isPausedSubject.next(true);
            this._mediaRecorder?.pause();
            this._recordingStateSubject.next('paused');
            AudioContext.pauseAnalyze();
            void this._audioContext.suspend();
            this._stopTimer();
            if (this._recordingEvents?.onPause)
                this._recordingEvents.onPause();
        };
    }
    _startTimer() {
        this._timeInterval = setInterval(() => {
            this._recordingTimeSubject.next(this._recordingTimeSubject.getValue() + 1);
        }, 1000);
    }
    _stopTimer() {
        clearInterval(this._timeInterval);
        this._timeInterval = undefined;
    }
    _getMp3() {
        const finalBuffer = this._mp3Encoder.finish();
        return new Promise((resolve, reject) => {
            if (finalBuffer.length === 0) {
                reject(new Error('No buffer to send'));
            }
            else {
                resolve(new Blob(finalBuffer, { type: 'audio/mp3' }));
                this._mp3Encoder.clearBuffer();
            }
        });
    }
    setRecordingEvents(events) {
        this._recordingEvents = events;
    }
}
NgxMicRecorderService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.2.7", ngImport: i0, type: NgxMicRecorderService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
NgxMicRecorderService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.2.7", ngImport: i0, type: NgxMicRecorderService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.2.7", ngImport: i0, type: NgxMicRecorderService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LW1pYy1yZWNvcmRlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LW1pYy1yZWNvcmRlci9zcmMvbGliL25neC1taWMtcmVjb3JkZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxlQUFlLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDN0QsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQzs7QUFZckQsTUFBTSxPQUFPLHFCQUFxQjtJQUhsQztRQUlVLHdCQUFtQixHQUFHLElBQUksZUFBZSxDQUFVLEtBQUssQ0FBQyxDQUFDO1FBQzFELHFCQUFnQixHQUFHLElBQUksZUFBZSxDQUFVLEtBQUssQ0FBQyxDQUFDO1FBQ3ZELDBCQUFxQixHQUFHLElBQUksZUFBZSxDQUFTLENBQUMsQ0FBQyxDQUFDO1FBQ3ZELHlCQUFvQixHQUFHLElBQUksZUFBZSxDQUFjLElBQUksQ0FBQyxDQUFDO1FBQzlELDJCQUFzQixHQUFHLElBQUksZUFBZSxDQUFpQixVQUFVLENBQUMsQ0FBQztRQUV6RSxrQkFBYSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxJQUFJLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUk1RSxnQkFBVyxHQUFHLElBQUksVUFBVSxFQUFFLENBQUM7UUFJaEMsaUJBQVksR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDdkQsY0FBUyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNqRCxtQkFBYyxHQUFHLElBQUksQ0FBQyxx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QyxtQkFBbUIsQ0FBQyxDQUFDLENBQUM7YUFDeEM7aUJBQU07Z0JBQ0wsT0FBTyxDQUFDLElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRSxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ3RELElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFLENBQUM7YUFDaEM7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTSxrQkFBa0IsQ0FBQyxNQUFnQztRQUN4RCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsTUFBTSxDQUFDO0lBQ2pDLENBQUM7O2tIQWhEVSxxQkFBcUI7c0hBQXJCLHFCQUFxQixjQUZwQixNQUFNOzJGQUVQLHFCQUFxQjtrQkFIakMsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgZnJvbSwgbWFwLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgTVAzRW5jb2RlciB9IGZyb20gJy4vdXRpbHMvbXAzLWVuY29kZXInO1xyXG5pbXBvcnQgeyBBdWRpb0NvbnRleHQgfSBmcm9tICcuL3V0aWxzL2F1ZGlvLWNvbnRleHQnO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBSZWNvcmRpbmdFdmVudHMge1xyXG4gIGFmdGVyU3RhcnRSZWNvcmRpbmc6ICgpID0+IHZvaWQ7XHJcbiAgYWZ0ZXJTdG9wUmVjb3JkaW5nOiAoYmxvYjogQmxvYikgPT4gdm9pZDtcclxuICBvblBhdXNlOiAoKSA9PiB2b2lkO1xyXG4gIG9uUmVzdW1lOiAoKSA9PiB2b2lkO1xyXG59XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBOZ3hNaWNSZWNvcmRlclNlcnZpY2Uge1xyXG4gIHByaXZhdGUgX2lzUmVjb3JkaW5nU3ViamVjdCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4oZmFsc2UpO1xyXG4gIHByaXZhdGUgX2lzUGF1c2VkU3ViamVjdCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4oZmFsc2UpO1xyXG4gIHByaXZhdGUgX3JlY29yZGluZ1RpbWVTdWJqZWN0ID0gbmV3IEJlaGF2aW9yU3ViamVjdDxudW1iZXI+KDApO1xyXG4gIHByaXZhdGUgX3JlY29yZGVkQmxvYlN1YmplY3QgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PEJsb2IgfCBudWxsPihudWxsKTtcclxuICBwcml2YXRlIF9yZWNvcmRpbmdTdGF0ZVN1YmplY3QgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFJlY29yZGluZ1N0YXRlPignaW5hY3RpdmUnKTtcclxuICBwcml2YXRlIF90aW1lSW50ZXJ2YWw/OiBhbnk7XHJcbiAgcHJpdmF0ZSBfYXVkaW9Db250ZXh0ID0gbmV3ICh3aW5kb3cuQXVkaW9Db250ZXh0IHx8IHdpbmRvd1snd2Via2l0QXVkaW9Db250ZXh0J10pKCk7XHJcbiAgcHJpdmF0ZSBfbWljPzogTWVkaWFTdHJlYW1BdWRpb1NvdXJjZU5vZGU7XHJcbiAgcHJpdmF0ZSBfcHJvY2Vzc29yPzogU2NyaXB0UHJvY2Vzc29yTm9kZTtcclxuICBwcml2YXRlIF9hY3RpdmVTdHJlYW0/OiBNZWRpYVN0cmVhbTtcclxuICBwcml2YXRlIF9tcDNFbmNvZGVyID0gbmV3IE1QM0VuY29kZXIoKTtcclxuICBwcml2YXRlIF9tZWRpYVJlY29yZGVyPzogTWVkaWFSZWNvcmRlcjtcclxuICBwcml2YXRlIF9yZWNvcmRpbmdFdmVudHM/OiBQYXJ0aWFsPFJlY29yZGluZ0V2ZW50cz47XHJcblxyXG4gIHB1YmxpYyBpc1JlY29yZGluZyQgPSB0aGlzLl9pc1JlY29yZGluZ1N1YmplY3QuYXNPYnNlcnZhYmxlKCk7XHJcbiAgcHVibGljIGlzUGF1c2VkJCA9IHRoaXMuX2lzUGF1c2VkU3ViamVjdC5hc09ic2VydmFibGUoKTtcclxuICBwdWJsaWMgcmVjb3JkaW5nVGltZSQgPSB0aGlzLl9yZWNvcmRpbmdUaW1lU3ViamVjdC5hc09ic2VydmFibGUoKS5waXBlKG1hcChzID0+IG5ldyBEYXRlKHMgKiAxMDAwKS50b0lTT1N0cmluZygpLnNsaWNlKDExLCAxOSkpKTtcclxuICBwdWJsaWMgcmVjb3JkZWRCbG9iJCA9IHRoaXMuX3JlY29yZGVkQmxvYlN1YmplY3QuYXNPYnNlcnZhYmxlKCk7XHJcbiAgcHVibGljIHJlY29yZGVkQmxvYkFzTXAzJCA9IHRoaXMucmVjb3JkZWRCbG9iJC5waXBlKHN3aXRjaE1hcCgoKSA9PiBmcm9tKHRoaXMuX2dldE1wMygpKSkpO1xyXG4gIHB1YmxpYyByZWNvcmRpbmdTdGF0ZSQgPSB0aGlzLl9yZWNvcmRpbmdTdGF0ZVN1YmplY3QuYXNPYnNlcnZhYmxlKCk7XHJcblxyXG4gIHByaXZhdGUgX3N0YXJ0VGltZXIoKTogdm9pZCB7XHJcbiAgICB0aGlzLl90aW1lSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XHJcbiAgICAgIHRoaXMuX3JlY29yZGluZ1RpbWVTdWJqZWN0Lm5leHQodGhpcy5fcmVjb3JkaW5nVGltZVN1YmplY3QuZ2V0VmFsdWUoKSArIDEpXHJcbiAgICB9LCAxMDAwKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgX3N0b3BUaW1lcigpOiB2b2lkIHtcclxuICAgIGNsZWFySW50ZXJ2YWwodGhpcy5fdGltZUludGVydmFsKTtcclxuICAgIHRoaXMuX3RpbWVJbnRlcnZhbCA9IHVuZGVmaW5lZDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgX2dldE1wMygpOiBQcm9taXNlPEJsb2I+IHtcclxuICAgIGNvbnN0IGZpbmFsQnVmZmVyID0gdGhpcy5fbXAzRW5jb2Rlci5maW5pc2goKTtcclxuXHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBpZiAoZmluYWxCdWZmZXIubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcignTm8gYnVmZmVyIHRvIHNlbmQnKSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmVzb2x2ZShuZXcgQmxvYihmaW5hbEJ1ZmZlciwgeyB0eXBlOiAnYXVkaW8vbXAzJyB9KSk7XHJcbiAgICAgICAgdGhpcy5fbXAzRW5jb2Rlci5jbGVhckJ1ZmZlcigpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzZXRSZWNvcmRpbmdFdmVudHMoZXZlbnRzOiBQYXJ0aWFsPFJlY29yZGluZ0V2ZW50cz4pIHtcclxuICAgIHRoaXMuX3JlY29yZGluZ0V2ZW50cyA9IGV2ZW50cztcclxuICB9XHJcblxyXG5cclxuICBwdWJsaWMgdG9nZ2xlU3RhcnRTdG9wID0gKCk6IHZvaWQgPT4gIHtcclxuICAgIGNvbnN0IGlzUmVjb3JkaW5nID0gdGhpcy5faXNSZWNvcmRpbmdTdWJqZWN0LmdldFZhbHVlKCk7XHJcblxyXG4gICAgaWYgKGlzUmVjb3JkaW5nKSB7XHJcbiAgICAgIHRoaXMuc3RvcFJlY29yZGluZygpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5zdGFydFJlY29yZGluZygpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIHN0YXJ0UmVjb3JkaW5nID0gKCk6IHZvaWQgPT4gIHtcclxuICAgIGlmICh0aGlzLl90aW1lSW50ZXJ2YWwgIT09IHVuZGVmaW5lZCkgcmV0dXJuO1xyXG5cclxuICAgIG5hdmlnYXRvci5tZWRpYURldmljZXNcclxuICAgICAgLmdldFVzZXJNZWRpYSh7IGF1ZGlvOiB0cnVlIH0pXHJcbiAgICAgIC50aGVuKChzdHJlYW0pID0+IHtcclxuICAgICAgICB0aGlzLl9hY3RpdmVTdHJlYW0gPSBzdHJlYW07XHJcbiAgICAgICAgdGhpcy5faXNSZWNvcmRpbmdTdWJqZWN0Lm5leHQodHJ1ZSk7XHJcbiAgICAgICAgY29uc3QgcmVjb3JkZXI6IE1lZGlhUmVjb3JkZXIgPSBuZXcgTWVkaWFSZWNvcmRlcihzdHJlYW0pO1xyXG4gICAgICAgIHRoaXMuX21lZGlhUmVjb3JkZXIgPSByZWNvcmRlcjtcclxuICAgICAgICByZWNvcmRlci5zdGFydCgpO1xyXG4gICAgICAgIHRoaXMuX3N0YXJ0VGltZXIoKTtcclxuICAgICAgICB0aGlzLl9yZWNvcmRpbmdTdGF0ZVN1YmplY3QubmV4dCgncmVjb3JkaW5nJyk7XHJcbiAgICAgICAgdGhpcy5fbWljID0gdGhpcy5fYXVkaW9Db250ZXh0LmNyZWF0ZU1lZGlhU3RyZWFtU291cmNlKHN0cmVhbSk7XHJcbiAgICAgICAgdGhpcy5fcHJvY2Vzc29yID0gdGhpcy5fYXVkaW9Db250ZXh0LmNyZWF0ZVNjcmlwdFByb2Nlc3NvcigwLCAxLCAxKTtcclxuICAgICAgICB0aGlzLl9taWMuY29ubmVjdCh0aGlzLl9wcm9jZXNzb3IpO1xyXG4gICAgICAgIHRoaXMuX3Byb2Nlc3Nvci5jb25uZWN0KHRoaXMuX2F1ZGlvQ29udGV4dC5kZXN0aW5hdGlvbik7XHJcblxyXG4gICAgICAgIHRoaXMuX3Byb2Nlc3Nvci5vbmF1ZGlvcHJvY2VzcyA9IChldmVudCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5fbXAzRW5jb2Rlci5lbmNvZGUoZXZlbnQuaW5wdXRCdWZmZXIuZ2V0Q2hhbm5lbERhdGEoMCkpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGlmICh0aGlzLl9yZWNvcmRpbmdFdmVudHM/LmFmdGVyU3RhcnRSZWNvcmRpbmcpIHRoaXMuX3JlY29yZGluZ0V2ZW50cz8uYWZ0ZXJTdGFydFJlY29yZGluZygpO1xyXG5cclxuICAgICAgICByZWNvcmRlci5hZGRFdmVudExpc3RlbmVyKCdkYXRhYXZhaWxhYmxlJywgKGV2ZW50OiBCbG9iRXZlbnQpID0+IHtcclxuICAgICAgICAgIHRoaXMuX3JlY29yZGVkQmxvYlN1YmplY3QubmV4dChldmVudC5kYXRhKTtcclxuICAgICAgICAgIC8vIGlmIChvbkRhdGFBdmFpbGFibGUpIG9uRGF0YUF2YWlsYWJsZShldmVudC5kYXRhKTtcclxuICAgICAgICAgIHJlY29yZGVyLnN0cmVhbS5nZXRUcmFja3MoKS5mb3JFYWNoKCh0KSA9PiB0LnN0b3AoKSk7XHJcbiAgICAgICAgICB0aGlzLl9tZWRpYVJlY29yZGVyID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIEF1ZGlvQ29udGV4dC5zdGFydEFuYWx5emUoc3RyZWFtKTtcclxuICAgICAgfSlcclxuICAgICAgLmNhdGNoKChlcnIpID0+IGNvbnNvbGUubG9nKGVycikpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHN0b3BSZWNvcmRpbmcgPSAoKTogdm9pZCA9PiB7XHJcbiAgICB0aGlzLl9tZWRpYVJlY29yZGVyPy5zdG9wKCk7XHJcbiAgICB0aGlzLl9zdG9wVGltZXIoKTtcclxuICAgIHRoaXMuX3JlY29yZGluZ1RpbWVTdWJqZWN0Lm5leHQoMClcclxuICAgIHRoaXMuX2lzUmVjb3JkaW5nU3ViamVjdC5uZXh0KGZhbHNlKTtcclxuICAgIHRoaXMuX2lzUGF1c2VkU3ViamVjdC5uZXh0KGZhbHNlKTtcclxuICAgIHRoaXMuX3JlY29yZGluZ1N0YXRlU3ViamVjdC5uZXh0KCdpbmFjdGl2ZScpO1xyXG4gICAgQXVkaW9Db250ZXh0LnJlc2V0QW5hbHlzZXIoKTtcclxuICAgIGlmICh0aGlzLl9yZWNvcmRpbmdFdmVudHM/LmFmdGVyU3RvcFJlY29yZGluZykgdGhpcy5fcmVjb3JkaW5nRXZlbnRzLmFmdGVyU3RvcFJlY29yZGluZyh0aGlzLl9yZWNvcmRlZEJsb2JTdWJqZWN0LmdldFZhbHVlKCkgYXMgQmxvYik7XHJcblxyXG4gICAgaWYgKHRoaXMuX3Byb2Nlc3NvciAmJiB0aGlzLl9taWMpIHtcclxuICAgICAgdGhpcy5fbWljLmRpc2Nvbm5lY3QoKTtcclxuICAgICAgdGhpcy5fcHJvY2Vzc29yLmRpc2Nvbm5lY3QoKTtcclxuICAgICAgaWYgKHRoaXMuX2F1ZGlvQ29udGV4dCAmJiB0aGlzLl9hdWRpb0NvbnRleHQuc3RhdGUgIT09ICdjbG9zZWQnKSB7XHJcbiAgICAgICAgdGhpcy5fYXVkaW9Db250ZXh0LmNsb3NlKCk7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5fcHJvY2Vzc29yLm9uYXVkaW9wcm9jZXNzID0gbnVsbDtcclxuICAgICAgdGhpcy5fYWN0aXZlU3RyZWFtPy5nZXRBdWRpb1RyYWNrcygpLmZvckVhY2goKHRyYWNrKSA9PiB0cmFjay5zdG9wKCkpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIHRvZ2dsZVBhdXNlQW5kUmVzdW1lID0gKCk6IHZvaWQgPT4ge1xyXG4gICAgY29uc3QgaXNSZWNvcmRpbmcgPSB0aGlzLl9pc1JlY29yZGluZ1N1YmplY3QuZ2V0VmFsdWUoKTtcclxuICAgIGlmICghaXNSZWNvcmRpbmcpIHJldHVybjtcclxuICAgIGNvbnN0IGlzUGF1c2VkID0gdGhpcy5faXNQYXVzZWRTdWJqZWN0LmdldFZhbHVlKCk7XHJcbiAgICBpZiAoaXNQYXVzZWQpIHtcclxuICAgICAgdGhpcy5yZXN1bWUoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMucGF1c2UoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyByZXN1bWUgPSAoKTogdm9pZCA9PiB7XHJcbiAgICB0aGlzLl9pc1BhdXNlZFN1YmplY3QubmV4dChmYWxzZSlcclxuICAgIHRoaXMuX21lZGlhUmVjb3JkZXI/LnJlc3VtZSgpO1xyXG4gICAgdGhpcy5fcmVjb3JkaW5nU3RhdGVTdWJqZWN0Lm5leHQoJ3JlY29yZGluZycpO1xyXG4gICAgQXVkaW9Db250ZXh0LnJlc3VtZUFuYWx5emUoKTtcclxuICAgIHZvaWQgdGhpcy5fYXVkaW9Db250ZXh0LnJlc3VtZSgpO1xyXG4gICAgdGhpcy5fc3RhcnRUaW1lcigpO1xyXG4gICAgaWYgKHRoaXMuX3JlY29yZGluZ0V2ZW50cz8ub25SZXN1bWUpIHRoaXMuX3JlY29yZGluZ0V2ZW50cy5vblJlc3VtZSgpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHBhdXNlID0gKCk6IHZvaWQgPT4ge1xyXG4gICAgdGhpcy5faXNQYXVzZWRTdWJqZWN0Lm5leHQodHJ1ZSk7XHJcbiAgICB0aGlzLl9tZWRpYVJlY29yZGVyPy5wYXVzZSgpO1xyXG4gICAgdGhpcy5fcmVjb3JkaW5nU3RhdGVTdWJqZWN0Lm5leHQoJ3BhdXNlZCcpO1xyXG4gICAgQXVkaW9Db250ZXh0LnBhdXNlQW5hbHl6ZSgpO1xyXG4gICAgdm9pZCB0aGlzLl9hdWRpb0NvbnRleHQuc3VzcGVuZCgpO1xyXG4gICAgdGhpcy5fc3RvcFRpbWVyKCk7XHJcbiAgICBpZiAodGhpcy5fcmVjb3JkaW5nRXZlbnRzPy5vblBhdXNlKSB0aGlzLl9yZWNvcmRpbmdFdmVudHMub25QYXVzZSgpO1xyXG4gIH1cclxuXHJcbn1cclxuIl19